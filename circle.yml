general:
  branches:
    ignore:
      - gh-pages

machine:
  timezone:
    Asia/Shanghai
  environment:
    PATH: $PATH:$HOME/.cargo/bin
    # Parallel gcc jobs for building Snappy and RocksDB.
    # See: https://github.com/hibari/hibari-brick-rs/issues/3
    CI_NUM_JOBS: 4

dependencies:
  post:
    - sudo apt update
    - sudo apt install curl file gcc git make openssh-client
    - sudo apt install libgflags-dev
    # Delete .gitconfig to prevent "cargo install" and "cargo build" from
    # failing when pulling the registry info (crates.io-index).
    # See https://github.com/rust-lang-ja/rust-by-example-ja/issues/38#issuecomment-238214915
    # NOTE: Assuming .gitconfig only has a rewrite rule for https://github.com
    - cat $HOME/.gitconfig; rm $HOME/.gitconfig
    # Install Rust
    - curl https://sh.rustup.rs -sSf | sh -s -- -y --no-modify-path
    - rustup self update
    - rustup update stable
    - rustup install beta; rustup update beta
    - rustup install nightly; rustup update nightly
    - rustup run stable rustc --version --verbose
    - rustup run stable cargo --version --verbose
    - rustup run beta rustc --version --verbose
    - rustup run beta cargo --version --verbose
    - rustup run nightly rustc --version --verbose
    - rustup run nightly cargo --version --verbose
  cache_directories:
    - "~/.cargo"

test:
  override:
    - rustup run nightly cargo clean
    - rustup run nightly cargo build --jobs $CI_NUM_JOBS --features=clippy:
        timeout: 900
    - rustup run stable cargo clean
    - rustup run stable cargo test --jobs $CI_NUM_JOBS --release:
        timeout: 900
    - rustup run stable cargo run --release --example simple
    - rustup run beta cargo clean
    - rustup run beta cargo test --jobs $CI_NUM_JOBS --release:
        timeout: 900
    - rustup run beta cargo run --release --example simple
