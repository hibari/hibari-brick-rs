general:
  branches:
    ignore:
      - gh-pages

machine:
  timezone:
    Asia/Shanghai
  environment:
    PATH: $PATH:$HOME/.cargo/bin

dependencies:
  post:
    - sudo apt-get update
    - sudo apt-get install curl file gcc git make openssh-client xz-utils
    - sudo apt-get install libgflags-dev libsnappy-dev
    # Delete .gitconfig to prevent "cargo install" and "cargo build" from
    # failing when pulling the registry info (crates.io-index).
    # See https://github.com/rust-lang-ja/rust-by-example-ja/issues/38#issuecomment-238214915
    # NOTE: Assuming .gitconfig only has a rewrite rule for https://github.com
    - cat $HOME/.gitconfig; rm $HOME/.gitconfig
    # Install Rust
    - curl https://sh.rustup.rs -sSf | sh -s -- -y --no-modify-path
    - rustup self update
    - rustup update stable
    - rustup install beta; rustup update beta
    - rustup install nightly; rustup update nightly
    - rustup run stable rustc --version --verbose
    - rustup run stable cargo --version --verbose
    - rustup run beta rustc --version --verbose
    - rustup run beta cargo --version --verbose
    - rustup run nightly rustc --version --verbose
    - rustup run nightly cargo --version --verbose
    # Build and install RocksDB (DISABLED)
    # - cd $HOME; curl -L -O https://github.com/facebook/rocksdb/archive/v${ROCKSDB_RELEASE}.tar.gz
    # - cd $HOME; tar xvf v${ROCKSDB_RELEASE}.tar.gz && cd rocksdb-${ROCKSDB_RELEASE} && make shared_lib && sudo make install
    # Install a pre-built RocksDB (DISABLED)
    # - sudo cp -p ./tools/circleci/files/librocksdb.so.4.9.0.ubuntu-14.04-x86_64.xz /usr/local/lib/librocksdb.so.4.9.0.xz
    # - cd /usr/local/lib && sudo xz -d librocksdb.so.4.9.0.xz && sudo ln -fs librocksdb.so.4.9.0 librocksdb.so.4.9 && sudo ln -fs librocksdb.so.4.9.0 librocksdb.so.4 && sudo ln -fs librocksdb.so.4.9.0 librocksdb.so
    # - ls -l /usr/local/lib/librocksdb*
  cache_directories:
    - "~/.cargo"

test:
  override:
    - rustup run nightly cargo clean
    - rustup run nightly cargo build --features=clippy:
        timeout: 1200
    - rustup run stable cargo clean
    - rustup run stable cargo test:
        timeout: 1200
    - rustup run stable cargo run --release:
        timeout: 1200
    - rustup run beta cargo clean
    - rustup run beta cargo test:
        timeout: 1200
    - rustup run beta cargo run --release:
        timeout: 1200
